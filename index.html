<!DOCTYPE html>
<html>
<head>
  <title>Veloleo ‚Äì Braunschweig (Live)</title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <!-- Geocoder CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>

  <style>
    body { margin:0; }
    #map { height:100vh; width:100vw; }

    #logo-link {
      position:absolute; top:10px; left:60px; z-index:1000;
      background:white; padding:5px; border-radius:8px;
      box-shadow:0 0 5px rgba(0,0,0,0.2);
    }
    #toggleCluster {
      position:absolute; bottom:60px; right:10px; z-index:1000;
      background:#fff; border:none; padding:8px 12px; border-radius:6px;
      box-shadow:0 0 4px rgba(0,0,0,0.3); cursor:pointer;
    }
    #locateMe {
      position:absolute; bottom:20px; right:10px; z-index:1000;
      background:#fff; border:none; padding:8px 12px; border-radius:6px;
      box-shadow:0 0 4px rgba(0,0,0,0.3); cursor:pointer;
    }

    .leaflet-control-geocoder {
      z-index:1100 !important;
      background:white; padding:4px;
      border-radius:6px; box-shadow:0 0 5px rgba(0,0,0,0.2);
    }
    .leaflet-control-geocoder-icon {
      width:34px !important; height:34px !important;
      background-size:70% 70% !important;
      background-position:center !important;
      background-color:white !important;
      border-radius:4px;
      box-shadow:0 0 3px rgba(0,0,0,0.3);
      opacity:1 !important;
    }
    @media (max-width:600px) {
      .leaflet-control-geocoder {
        margin-top:60px; max-width:90%;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <a id="logo-link" href="https://www.nextbike.de/veloleo/de/" target="_blank" rel="noopener">
    <img src="https://www.nextbike.de/veloleo/wp-content/uploads/sites/39/2025/01/Logo-2.svg" alt="Veloleo Logo" style="height:50px;">
  </a>

  <button id="toggleCluster">Cluster einblenden</button>
  <button id="locateMe">üìç Mein Standort</button>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <script>
    const map = L.map('map').setView([52.264,10.526],13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution:'¬© OpenStreetMap-Mitwirkende'
    }).addTo(map);
    L.Control.geocoder({position:'bottomleft'}).addTo(map);

    const bikeIcon = L.icon({
      iconUrl:'bike-icon.png',
      iconSize:[40,40],
      iconAnchor:[20,40],
      popupAnchor:[0,-40]
    });

    const markers = L.markerClusterGroup();
    const plainMarkers = L.layerGroup();
    let clusteringEnabled = false;

    const DISCOVERY = 'https://gbfs.nextbike.net/maps/gbfs/v2/nextbike_bs/gbfs.json';

    fetch(DISCOVERY)
      .then(res => res.json())
      .then(d => {
        const feeds = Object.fromEntries(d.data.en.feeds.map(f => [f.name, f.url]));
        return Promise.all([
          fetch(feeds.station_information).then(r=>r.json()),
          fetch(feeds.station_status).then(r=>r.json())
        ]);
      })
      .then(([info, status]) => {
        const infoMap = Object.fromEntries(info.data.stations.map(s => [s.station_id,s]));
        const features = status.data.stations.map(s => {
          const i = infoMap[s.station_id];
          if (!i) return null;
          return {
            type:'Feature',
            geometry:{type:'Point', coordinates:[i.lon,i.lat]},
            properties:{
              name:i.name,
              bikes:s.num_bikes_available,
              docks:s.num_docks_available
            }
          };
        }).filter(Boolean);

        const layer = L.geoJSON(features, {
          pointToLayer:(f, latlng) => L.marker(latlng, {icon: bikeIcon}),
          onEachFeature:(f, lyr) => {
            const p = f.properties;
            const txt = `<b>${p.name}</b><br>R√§der: ${p.bikes} / ${p.docks}`;
            lyr.bindPopup(txt);
            lyr.on('mouseover',()=>lyr.openPopup());
            lyr.on('mouseout',()=>lyr.closePopup());
          }
        });

        markers.addLayer(layer);
        plainMarkers.addLayer(layer);
        map.addLayer(plainMarkers);
      })
      .catch(e => {
        console.error('GBFS Error', e);
        alert('Stationsdaten konnten nicht geladen werden.');
      });

    document.getElementById('toggleCluster').onclick = function() {
      if (clusteringEnabled) {
        map.removeLayer(markers);
        map.addLayer(plainMarkers);
        this.innerText = 'Cluster einblenden';
      } else {
        map.removeLayer(plainMarkers);
        map.addLayer(markers);
        this.innerText = 'Cluster ausblenden';
      }
      clusteringEnabled = !clusteringEnabled;
    };

    document.getElementById('locateMe').onclick = function() {
      if (!navigator.geolocation) return alert('Geolocation nicht unterst√ºtzt.');
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        map.setView([lat,lng],15);
        L.circleMarker([lat,lng], {
          radius:8, color:'#007aff', fillColor:'#007aff', fillOpacity:0.8
        }).addTo(map).bindPopup('Du bist hier').openPopup();
      }, () => alert('Standort konnte nicht ermittelt werden.'));
    };
  </script>
</body>
</html>
